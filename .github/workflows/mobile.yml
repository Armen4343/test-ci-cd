name: Build and Deploy
on:
  push:
    tags:
      - 'v*.*.*'

env:
  DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
    - name: Extract Git tag
      id: extract_tag
      run: echo ::set-output name=TAG::${GITHUB_REF/refs\/tags\//}
        
    - name: deploy to prod
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_HOST_USER }}
        password: ${{ secrets.SSH_HOST_USER_PASSWORD }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          echo "DOCKER_REGISTRY is set to: ${{ secrets.DOCKER_REGISTRY }}"
          echo "DOCKER_REGISTRY is set to: $DOCKER_REGISTRY"
          echo "bobbobo"
          echo "$DOCKER_REGISTRY:${{ steps.extract_tag.outputs.TAG }}"
          docker pull "$DOCKER_REGISTRY:${{ steps.extract_tag.outputs.TAG }}"

          if docker ps -a --format '{{.Names}}' | grep -w mobile_zeepup > /dev/null; then
          docker rm -f mobile_zeepup
          fi

          docker run --name mobile_zeepup --restart always -d -p 8080:80 "$DOCKER_REGISTRY:${{ steps.extract_tag.outputs.TAG }}"


         # docker pull "$DOCKER_REGISTRY":v0.0.1
          #docker rm -f mobile_zeepup || true
          #docker run --name mobile_zeepup --restart always -d -p 8000:80 "$DOCKER_REGISTRY":v0.0.1